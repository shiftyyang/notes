## 方案背景：

随着公司产品的扩增迭进，与更多平台方的合作加深，一个稳定、优异的基础服务将会显得越来越重要，它决定了公司其它产品线能否走的更加轻松、迅捷和稳健。

UC 作为一个基础服务系统，目前面临很多困境。**其一，功能不够内聚、边界不够清晰。经常会发生业务系统的需求变化，导致 UC 也要跟着改动。其二，承担了太多的负担。越来越多的功能堆积，系统已经向着庞杂和紊乱越走越远。其三，容错率越来越低。一个功能出现问题，会影响整个 UC 系统的服务运行，扩展到公司所有服务都无法正常使用。**



## 实现目标：

基于 UC 当前所遇到的困境，结合现下企业系统架构的解决方案，对 UC 系统进行微服务拆分。目标降低系统的复杂度，提高系统的稳定性和容错性，划定清晰的功能边界。利用公司现有搭建的 k8s 平台，为 UC 提供完善的服务治理、灾备处理能力。



## 现状描述：

**UC 目前主要功能分类：**

* **账号系统管理 **

  [企业注册.md](企业注册.md) 

* **用户身份验证**

  [UC 现有登录方式.md](UC 现有登录方式.md) 

* **组织架构管理**

* **应用套餐管理**

* **权限角色管理**

* **事件推送系统**

* **信息查询能力**

* **第三方相关功能**



## 方案分析：

### 合理拆分

**针对 UC 现有功能模块，根据服务的功能特性，可主要划分为以下几大模块**：

1. **基础账号微服务**

   > 主要负责账号创建、管理修改、登录等功能

2. **组织架构管理微服务**

   > 主要负责组织结构管理、合并、查询等

3. **权限角色管理微服务**

   > 主要负责用户应用授权、超管设置、角色设置等

4. **应用套餐管理微服务**

   > 主要负责套餐接收管理

5. **SaaS 第三方微服务**

	> 主要负责第三方的对接、登录、注册、事件处理等

![用户中心草图](http://blog-shifty.oss-cn-shanghai.aliyuncs.com/uPic/%E7%94%A8%E6%88%B7%E4%B8%AD%E5%BF%83%E8%8D%89%E5%9B%BE.png)

### 实行阻碍

1. **基础账号管理**
   * 账号创建方式多样化
   * 现行登录方式多样化，且登录成功的判断条件与业务方的多个功能相关（授权、套餐、用户状态、企业禁用等)
   * 作为对接方而不是平台方，我们的登录方式受到不同第三方的制约，需要兼容所有第三方的要求
   * 业务层面对于账号的特殊限制散落在各处，如何整理统一
   * 不同平台账号原设计存储模式是加前缀处理，各处涉及功能又需要针对不同平台做去前缀处理，比如发送短信、不同平台登录等。

2. **组织架构管理**
   * 无法统一组织架构模式，不同平台方的限制不同，可见范围的不同导致拿不到完整的组织
   * 不同平台方，可能拿不到用户、部门信息等，需要以特殊的方式展示（比如通讯录组件）
   * 修改删除部门用户等有很多业务限制，比如授权超管、角色、用户继承等。

3. **权限角色管理**
   * 角色的创建由业务方控制，管理由 UC 控制，分属不同处，难以做到统一管理
   * 权限修改受制于角色（非超管角色无法设置管理权限），业务设计不够清晰，功能间过于耦合
   * 授权管理和角色、权限、应用工号都有关联，业务逻辑较复杂耦合，拆分困难

4. **应用套餐管理**
   * 套餐与计算模块信息相关，模块信息作为业务方判断能否使用的重要依据，且用户中心内部判断用户能否正常使用都依赖于模块信息，逻辑散落各处
5. **SaaS 第三方服务**
   * 每个接入平台的注册方式和登录方式都不相同
   * 回调地址和 ip 白名单等配置问题
6. **数据存储结构**

### 现行痛点

1. 第三方问题，新接入复杂、变更改动复杂
2. 登录、注册频繁变动，流程复杂，依赖项过多
3. 容错性、稳定性
4. 安全性



## 方案设计：

**逐步递进**

1. 结合现有登录方式，统一身份验证功能，将业务功能校验分离出去。独立出基础账号微服务
2. 拆离第三方服务
3. 服务治理和动态伸缩容



## 方案难点：

1. 业务系统代码过于耦合
2. 存储结构设计变更困难
3. 遗留代码硬编码方式改动成本、风险较高
4. 隐藏逻辑难以估计
5. 很多功能难以做到兼容，所有调用方需要配合修改











